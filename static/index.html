<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Hello World</title>
    <style type="text/css">
        .ng-cloak {
            display: none !important;
        }
    </style>
</head>

<body ng-app="angularExample">

<div ng-controller="PostIndexCtrl">
    <input type="text" ng-change="update()" ng-model="topic"/>

    <div ng-bind-html="renderHtml(result)" id="topTweets"></div>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.2.22/angular.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.2.22/angular-resource.js"></script>

<script>window.twttr = (function (d, s, id) {
    var t, js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s);
    js.id = id;
    js.src = "https://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js, fjs);
    return window.twttr || (t = { _e: [], ready: function (f) {
        t._e.push(f)
    } });
}(document, "script", "twitter-wjs"));</script>

<script type="text/javascript">
    "use strict";

    var app = angular.module('angularExample', ['ngResource']);

    app.factory('twitterService', ['$http', function ($http) {

        function embed(id, callback) {
            $http.get('/embedData', {
                params: {
                    id: id
                }
            }).success(callback);
        }


        function search(q, count, callback) {
            $http.get('/tweets', {
                params: {
                    q: q,
                    count: count
                }
            }).success(callback);
        }

        return {
            search: search,
            embed: embed
        };
    }]);


    app.controller('PostIndexCtrl', ['twitterService', '$scope', '$sce', '$timeout', function (twitterService, $scope, $sce, $timeout) {
        $scope.topic = "haskell";
        $scope.posts = 'lol';

        $scope.renderHtml = function (html_code) {
            return $sce.trustAsHtml(html_code);
        };

        $scope.update = function () {
            $scope.result = "";

            function embedCallback(data) {
                $scope.result += data['html'];
                twttr.widgets.load();
            }

            function searchCallback(data) {
//                console.log(data);
                data['tweets'].forEach(function (tweet) {
                    twitterService.embed(tweet['id_str'], embedCallback)
                })
            }

            twitterService.search($scope.topic, 5, searchCallback)
        };
    }]);

</script>
</body>
</html>
